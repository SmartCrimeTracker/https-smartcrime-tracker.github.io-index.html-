<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Crime Tracker â€” Presentation Demo</title>
<meta name="description" content="Smart Crime Tracker â€” Presentation / Demo (UI-only, no live telecom hooks)" />
<style>
  :root{
    --bg1:#031218; --bg2:#00372e;
    --card: rgba(6,18,16,0.88);
    --glass: rgba(255,255,255,0.03);
    --accent:#00e486; --accent2:#16c7ff;
    --muted:#9fdad0; --uiText:#e9fff6;
    --shadow: 0 14px 40px rgba(0,0,0,0.55);
    --glassBorder: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial;color:var(--uiText);background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
  /* animated subtle stars */
  .stars{position:fixed;inset:0;z-index:0;pointer-events:none;background:
    radial-gradient(1px 1px at 5% 10%, #fff 60%, transparent 61%),
    radial-gradient(1px 1px at 20% 30%, #fff 60%, transparent 61%),
    radial-gradient(1px 1px at 35% 60%, #fff 60%, transparent 61%),
    radial-gradient(1px 1px at 50% 20%, #fff 60%, transparent 61%),
    radial-gradient(1px 1px at 65% 45%, #fff 60%, transparent 61%),
    radial-gradient(1px 1px at 80% 70%, #fff 60%, transparent 61%);opacity:.35}
  header{position:relative;z-index:3;padding:14px 22px;display:flex;align-items:center;gap:14px}
  .logoWrap{width:70px;height:70px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#009b66);display:grid;place-items:center;box-shadow:0 12px 30px rgba(0,230,134,0.08)}
  .brandTitle h1{margin:0;font-size:18px;letter-spacing:1px}
  .brandTitle p{margin:4px 0 0;color:var(--muted);font-size:13px}

  /* topbar nav */
  .topbar{display:flex;align-items:center;padding:12px 22px;gap:12px;border-top:1px solid rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.02);background:linear-gradient(90deg, rgba(0,0,0,0.08), rgba(0,0,0,0.02));z-index:2}
  .nav{display:flex;gap:8px}
  .nav button{background:transparent;border:1px solid var(--glassBorder);color:var(--muted);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
  .nav button.active{border-color:rgba(0,230,134,0.45);color:var(--uiText);background:linear-gradient(90deg, rgba(0,230,134,0.04), rgba(0,230,134,0.01))}

  .userInfo{margin-left:auto;color:var(--muted);font-size:13px}

  /* layout */
  .layout{display:grid;grid-template-columns:1fr 420px;gap:18px;padding:18px;min-height:calc(100vh - 180px);z-index:2}
  @media (max-width:980px){.layout{grid-template-columns:1fr;padding:12px}}
  .panel{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--glassBorder);box-shadow:var(--shadow)}
  .kpis{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .kpi{flex:1;min-width:140px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
  .kpi .num{font-size:22px;font-weight:800;color:var(--accent)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.grid2{grid-template-columns:1fr}}

  input[type=text], textarea, select{background:var(--glass);border:1px solid var(--glassBorder);color:inherit;padding:10px;border-radius:8px;outline:none;width:100%}
  button.btn{background:linear-gradient(180deg,var(--accent),#00b36a);border:none;padding:10px 14px;border-radius:10px;color:#012;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px}
  .tiny{font-size:13px;color:var(--muted)}
  .note{font-size:13px;color:var(--muted);margin-top:8px}

  table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02);font-size:13px}
  tr:hover td{background:rgba(0,0,0,0.06)}
  .mapFrame{width:100%;height:300px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}

  .foot{padding:12px;text-align:center;color:var(--muted);font-size:13px}

  /* login modal */
  #loginModal{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.7));z-index:9}
  .loginCard{width:460px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 60px rgba(0,0,0,0.75)}
  .loginCard h3{margin:0 0 8px;color:var(--accent)}
  .logoSvg{width:46px;height:46px}

  /* small toast */
  #toast{position:fixed;right:18px;bottom:18px;background:#012b23;border:1px solid rgba(0,230,134,0.08);padding:10px 14px;border-radius:10px;color:#dff;opacity:0;transform:translateY(8px);transition:all .25s}
  .hidden{display:none}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace}
</style>
</head>
<body>
  <div class="stars" aria-hidden="true"></div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" role="dialog" aria-labelledby="loginTitle">
    <div class="loginCard">
      <div style="display:flex;gap:12px;align-items:center">
        <div id="loginLogo" class="logoWrap" aria-hidden="true">
          <!-- default inline SVG -->
          <svg viewBox="0 0 64 64" class="logoSvg" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs><linearGradient id="lg" x1="0" x2="1"><stop offset="0" stop-color="#00e486"/><stop offset="1" stop-color="#16c7ff"/></linearGradient></defs>
            <path d="M32 6c9 6 18 6 18 6v16c0 14-9 21-18 24-9-3-18-10-18-24V12s9 0 18-6Z" stroke="url(#lg)" stroke-width="2.4" fill="rgba(0,255,150,0.04)"/>
            <circle cx="24" cy="26" r="2.4" stroke="#00ffb0"/><circle cx="32" cy="33" r="2.4" stroke="#00ffb0"/><circle cx="40" cy="25" r="2.4" stroke="#00ffb0"/>
          </svg>
        </div>
        <div>
          <h3 id="loginTitle">SMART CRIME TRACKER â€” PRESENTATION DEMO</h3>
          <div class="tiny">Demo credentials: <b>admin / Allah@1</b> â€¢ <span style="opacity:.9">user / 1234</span></div>
        </div>
      </div>

      <hr style="border:none;height:8px;background:linear-gradient(90deg,transparent,rgba(0,255,150,0.06),transparent);margin:12px 0 14px"/>

      <label class="tiny">User</label>
      <input id="Luser" type="text" placeholder="admin" style="width:100%;padding:10px;margin-bottom:8px"/>

      <label class="tiny">Password</label>
      <input id="Lpass" type="password" placeholder="Allah@1" style="width:100%;padding:10px;margin-bottom:12px"/>

      <div style="display:flex;gap:8px">
        <button class="btn" onclick="doLogin()">Enter</button>
        <button class="ghost" onclick="fillQuick()">Fill demo</button>
      </div>
      <p id="Lmsg" class="tiny" style="margin-top:10px;color:#ffb3b3"></p>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="app" aria-hidden="true">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <div id="logoBox" class="logoWrap" aria-hidden="true" style="width:56px;height:56px"></div>
        <div class="brandTitle">
          <h1>SMART CRIME TRACKER</h1>
          <p class="tiny">Presentation â€¢ Demo UI â€” No live telecom hooks</p>
        </div>
      </div>
    </header>

    <div class="topbar" role="navigation" aria-label="Main">
      <nav class="nav">
        <button class="navbtn active" data-tab="dashboard" onclick="navTo(event)">Dashboard</button>
        <button class="navbtn" data-tab="search" onclick="navTo(event)">Number Search</button>
        <button class="navbtn" data-tab="cdr" onclick="navTo(event)">CDR</button>
        <button class="navbtn" data-tab="map" onclick="navTo(event)">Map</button>
        <button class="navbtn" data-tab="ai" onclick="navTo(event)">AI</button>
        <button class="navbtn" data-tab="fb" onclick="navTo(event)">Facebook</button>
        <button class="navbtn" data-tab="admin" onclick="navTo(event)">Admin</button>
      </nav>
      <div class="userInfo" id="userInfo">Not signed in</div>
    </div>

    <div class="layout">
      <main>
        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="panel">
          <div class="kpis">
            <div class="kpi"><div class="tiny">Active Cases</div><div class="num mono" id="kActive">0</div></div>
            <div class="kpi"><div class="tiny">High Risk</div><div class="num mono" id="kHigh">0</div></div>
            <div class="kpi"><div class="tiny">Alerts Today</div><div class="num mono" id="kAlerts">0</div></div>
          </div>

          <div class="grid2">
            <div class="panel">
              <h4 style="margin:0 0 8px;color:var(--accent)">Quick Actions</h4>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn" onclick="openTab('search')">ðŸ”Ž Number Search</button>
                <button class="btn" onclick="openTab('map')">ðŸ›° Map</button>
                <button class="btn" onclick="openTab('cdr')">ðŸ“‹ Load CDR</button>
                <button class="btn" onclick="openTab('ai')">ðŸ¤– Run AI</button>
              </div>
            </div>

            <div class="panel">
              <h4 style="margin:0 0 8px;color:var(--accent)">Recent Alerts (Demo)</h4>
              <table aria-live="polite">
                <thead><tr><th>Time</th><th>Event</th><th>Risk</th></tr></thead>
                <tbody id="alertsTbl"><tr><td>09:12</td><td>Unusual port activity</td><td style="color:#ffd700">Medium</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- NUMBER SEARCH -->
        <section id="tab-search" class="panel" style="display:none">
          <h4 style="color:var(--accent);margin-top:0">Number Search</h4>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
            <input id="searchNum" placeholder="e.g. 01700000000"/>
            <button class="btn" onclick="doNumberSearch()">Search</button>
            <button class="ghost" onclick="clearSearch()">Clear</button>
          </div>
          <div id="searchResult"></div>
        </section>

        <!-- CDR -->
        <section id="tab-cdr" class="panel" style="display:none">
          <h4 style="color:var(--accent);margin-top:0">Call Detail Records (Demo)</h4>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button class="btn" onclick="loadCDR()">Load Sample CDR</button>
            <button class="ghost" onclick="exportCDR()">Export CSV</button>
          </div>
          <div style="overflow:auto">
            <table id="cdrTbl"><thead><tr><th>Time</th><th>Caller</th><th>Callee</th><th>Dur(s)</th><th>Cell</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <!-- AI -->
        <section id="tab-ai" class="panel" style="display:none">
          <h4 style="color:var(--accent);margin-top:0">AI Analyzer (Demo)</h4>
          <p class="tiny">Paste event text â€” demo highlights suspicious keywords and produces a risk score.</p>
          <textarea id="aiInput" placeholder="Example: cash drop at port, meet handler at gate 3"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="runAIDemo()">Analyze</button>
            <button class="ghost" onclick="clearAIDemo()">Clear</button>
          </div>
          <div id="aiOut" style="margin-top:12px"></div>
        </section>

        <!-- FACEBOOK -->
        <section id="tab-fb" class="panel" style="display:none">
          <h4 style="color:var(--accent);margin-top:0">Facebook / Social (Demo)</h4>
          <p class="tiny">Paste a public profile link â€” demo only (no Graph API calls).</p>
          <div style="display:flex;gap:8px">
            <input id="fbUrl" placeholder="https://facebook.com/username"/>
            <button class="btn" onclick="fbAnalyze()">Analyze</button>
            <button class="ghost" onclick="fbClear()">Clear</button>
          </div>
          <div id="fbOut" style="margin-top:12px"></div>
        </section>
      </main>

      <aside>
        <div class="panel" style="margin-bottom:12px">
          <h4 style="margin:0 0 8px;color:var(--accent)">Map (Embed Demo)</h4>
          <div class="mapFrame">
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d14604.69688454172!2d90.40744!3d23.7104!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1" style="width:100%;height:100%;border:0" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <h4 style="margin:0 0 8px;color:var(--accent)">Suspicious Handlers</h4>
          <table><thead><tr><th>Handler</th><th>Score</th></tr></thead><tbody id="handlerTbl"><tr><td>HND-0173****210</td><td>78</td></tr><tr><td>HND-0182****905</td><td>64</td></tr></tbody></table>
          <div style="margin-top:8px"><button class="btn" onclick="analyzeHandlers()">Re-analyze</button></div>
        </div>

        <div class="panel">
          <h4 style="margin:0 0 8px;color:var(--accent)">Admin Approval</h4>
          <table id="adminTbl"><thead><tr><th>Request</th><th>User</th><th>Status</th><th>Action</th></tr></thead>
            <tbody>
              <tr><td>CDR Access: 01700000000</td><td>ops_17</td><td id="req0">Pending</td><td><button class="navbtn" onclick="approve(0)">Approve</button> <button class="navbtn" onclick="reject(0)">Reject</button></td></tr>
              <tr><td>Geo Sweep: Tati Bazar</td><td>op_unit</td><td id="req1">Pending</td><td><button class="navbtn" onclick="approve(1)">Approve</button> <button class="navbtn" onclick="reject(1)">Reject</button></td></tr>
            </tbody></table>
        </div>

        <!-- Logo Management (Admin) -->
        <div class="panel" style="margin-top:12px">
          <h4 style="margin:0 0 8px;color:var(--accent)">Logo â€” Upload / Save / Download / Reset</h4>
          <div style="display:flex;gap:8px;flex-direction:column">
            <label class="tiny">Upload logo (SVG or PNG/JPG)</label>
            <input id="logoFile" type="file" accept="image/*,image/svg+xml">
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
              <button class="btn" id="saveLogoBtn">Save Logo</button>
              <button class="ghost" id="downloadLogoBtn">Download Logo</button>
              <button class="ghost" id="resetLogoBtn">Reset Default</button>
            </div>
            <div style="margin-top:10px">
              <div class="tiny">Preview:</div>
              <div id="logoPreview" style="width:120px;height:80px;border-radius:8px;background:rgba(255,255,255,0.02);display:grid;place-items:center;padding:6px;margin-top:6px"></div>
              <div class="note" style="margin-top:8px">Logo saved locally in this browser (localStorage). For site-wide storage, use a server endpoint.</div>
            </div>
          </div>
        </div>

      </aside>
    </div>

    <div class="foot">Presentation Demo â€¢ Use only with lawful authorization â€¢ Â© Smart Crime Tracker</div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
/* -------------------------
   Utilities & Toast
   ------------------------- */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const toast = (t) => {
  const el = $('#toast'); el.textContent = t; el.style.opacity = 1; el.style.transform = 'translateY(0)';
  setTimeout(()=>{ el.style.opacity = 0; el.style.transform = 'translateY(8px)'; }, 2000);
};

/* -------------------------
   Login modal + bootstrap
   ------------------------- */
function doLogin(){
  const u = $('#Luser').value.trim(), p = $('#Lpass').value;
  if(!u||!p){ $('#Lmsg').textContent='Enter credentials'; return; }
  if((u==='admin' && p==='Allah@1') || (u==='user' && p==='1234')){
    $('#loginModal').style.display = 'none';
    $('#app').removeAttribute('aria-hidden');
    $('#userInfo').textContent = `Signed in: ${u}`;
    window.currentUser = u;
    toast('Logged in as '+u);
    bootstrap();
    loadSavedLogo(); // show logo if saved
  } else { $('#Lmsg').textContent='Invalid demo credentials'; }
}
function fillQuick(){ $('#Luser').value='admin'; $('#Lpass').value='Allah@1'; $('#Lmsg').textContent=''; }

function bootstrap(){
  animate('#kActive',5,30); animate('#kHigh',1,40); animate('#kAlerts',2,40);
  analyzeHandlers();
}
function animate(sel,target,ms){
  let n=0; const el=$(sel); const iv = setInterval(()=>{ n++; el.textContent=n; if(n>=target) clearInterval(iv); }, ms);
}

/* -------------------------
   Navigation
   ------------------------- */
function navTo(e){
  $$('.nav button').forEach(b=>b.classList.remove('active'));
  e.currentTarget.classList.add('active');
  const tab = e.currentTarget.dataset.tab;
  $$('#app main section').forEach(s=>s.style.display='none');
  const el = document.querySelector('#tab-'+tab);
  if(el) el.style.display='block';
}
function openTab(name){ const btn = Array.from($$('.nav button')).find(b=>b.dataset.tab===name); if(btn) btn.click(); }

/* -------------------------
   Number Search (demo)
   ------------------------- */
function doNumberSearch(){
  const q = $('#searchNum').value.trim(); const out = $('#searchResult'); out.innerHTML='';
  if(!q){ out.textContent='Provide number'; return; }
  let resp;
  if(q.match(/^01(70|71|73)/)) resp = `<b>${q}</b> â€” Owner: Unknown (Flagged) â€¢ LastSeen: Motijheel â€¢ <span style="color:#ffd700">Risk: High</span>`;
  else if(q.match(/^01(8|9)/)) resp = `<b>${q}</b> â€” Owner: Local Trader â€¢ Location: Bashundhara â€¢ <span style="color:#9fdad0">Risk: Low</span>`;
  else resp = `<b>${q}</b> â€” No public records (demo)`;
  out.innerHTML = `<div style="padding:10px;background:rgba(0,0,0,0.12);border-radius:8px">${resp}</div>`;
  toast('Number search (demo) complete');
}
function clearSearch(){ $('#searchNum').value=''; $('#searchResult').innerHTML=''; }

/* -------------------------
   CDR (demo) & Export
   ------------------------- */
const SAMPLE = [
  {t:'2025-09-01 09:12', caller:'01700000001', callee:'01800000002', dur:120, cell:'Dhaka'},
  {t:'2025-09-01 11:05', caller:'01800000002', callee:'01700000003', dur:45, cell:'Chattogram'},
  {t:'2025-09-02 23:50', caller:'01700000001', callee:'01900000004', dur:12, cell:'Rangpur'},
  {t:'2025-09-03 10:10', caller:'01700000005', callee:'01700000001', dur:35, cell:'Sylhet'}
];
function loadCDR(){ renderCDR(SAMPLE); toast('Sample CDR loaded'); }
function renderCDR(rows){ const t=$('#cdrTbl tbody'); t.innerHTML=''; (rows||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.t}</td><td>${r.caller}</td><td>${r.callee}</td><td>${r.dur}</td><td>${r.cell}</td>`; t.appendChild(tr); }); }
function exportCDR(){
  const rows = SAMPLE;
  if(!rows.length){ toast('No CDR'); return; }
  const csv = ['Time,Caller,Callee,Duration,Cell', ...rows.map(r=>`${r.t},${r.caller},${r.callee},${r.dur},${r.cell}`)].join('\n');
  const b = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='cdr_demo.csv'; a.click(); toast('CDR exported');
}

/* -------------------------
   Handlers analyze
   ------------------------- */
function analyzeHandlers(){
  const tbl = $('#handlerTbl'); tbl.innerHTML=''; ['HND-0173****210','HND-0182****905','HND-0167****441','HND-0199****332'].forEach(n=>{
    const sc = 40+Math.floor(Math.random()*50);
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${n}</td><td>${sc}</td>`;
    tbl.appendChild(tr);
  });
  toast('Handlers analyzed (demo)');
}

/* -------------------------
   AI demo (keyword highlight + scoring)
   ------------------------- */
const BAD = ['cash','drop','handler','gold','port','gate','transfer','hawala','parcel','meet','sell','buy'];
function runAIDemo(){
  const txt = $('#aiInput').value.trim();
  if(!txt){ toast('Write text to analyze'); return; }
  const tokens = txt.split(/\b/);
  const processed = tokens.map(t => BAD.includes(t.toLowerCase())? `<mark style="background:rgba(255,215,0,0.22);padding:2px;border-radius:3px">${t}</mark>`:t).join('');
  const score = Math.min(98, (txt.match(/\d+/g)||[]).join('').length + Math.min(70,Math.floor(txt.length/2)));
  $('#aiOut').innerHTML = `<div style="background:rgba(0,0,0,0.12);padding:12px;border-radius:8px"><b>Risk Score:</b> ${score}% &nbsp; <span style="color:${score>70?'#ff6b6b':'#ffd166'}">${score>70?'High':'Moderate'}</span><div style="margin-top:8px">${processed}</div></div>`;
  toast('AI demo complete');
}
function clearAIDemo(){ $('#aiInput').value=''; $('#aiOut').innerHTML=''; }

/* -------------------------
   Facebook demo (placeholder)
   ------------------------- */
function fbAnalyze(){
  const url = $('#fbUrl').value.trim();
  if(!url){ toast('Paste a profile link'); return; }
  const name = (url.match(/facebook\.com\/([^\/?#]+)/i)||[])[1]||'unknown';
  const s = 40 + Math.floor(Math.random()*60);
  $('#fbOut').innerHTML = `<div style="background:rgba(0,0,0,0.12);padding:10px;border-radius:8px"><b>${name}</b> â€” Public signals score: <b>${s}%</b></div>`;
  toast('FB demo scored');
}
function fbClear(){ $('#fbUrl').value=''; $('#fbOut').innerHTML=''; }

/* -------------------------
   Admin approve/reject (demo)
   ------------------------- */
function approve(i){ $('#req'+i).textContent='Approved'; toast('Approved (demo)'); }
function reject(i){ $('#req'+i).textContent='Rejected'; toast('Rejected (demo)'); }

/* -------------------------
   Logo upload / save / download / reset (localStorage)
   ------------------------- */
const LOGO_KEY = 'sct_logo_v1';
function isAdmin(){ return window.currentUser === 'admin'; }

function loadSavedLogo(){
  const raw = localStorage.getItem(LOGO_KEY);
  const logoBox = $('#logoBox'), loginLogo = $('#loginLogo');
  const preview = $('#logoPreview');
  if(!logoBox) return;
  if(!raw){
    // default inline logo
    logoBox.innerHTML = document.getElementById('loginLogo').innerHTML;
    if(preview) preview.innerHTML = '<div class="tiny" style="opacity:.8">Default</div>';
    return;
  }
  if(raw.startsWith('<svg') || raw.includes('<svg')){
    logoBox.innerHTML = raw;
    if(loginLogo) loginLogo.innerHTML = raw;
    if(preview) preview.innerHTML = raw;
  } else if(raw.startsWith('data:')){
    logoBox.innerHTML = `<img src="${raw}" style="max-width:100%;max-height:100%;border-radius:8px">`;
    if(loginLogo) loginLogo.innerHTML = `<img src="${raw}" style="max-width:100%;max-height:56px;border-radius:8px">`;
    if(preview) preview.innerHTML = `<img src="${raw}" style="max-width:100%;max-height:100%;border-radius:6px">`;
  } else {
    logoBox.innerHTML = raw;
    if(preview) preview.innerHTML = raw;
  }
}

const logoFileEl = $('#logoFile');
if(logoFileEl){
  logoFileEl.addEventListener('change', (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    const preview = $('#logoPreview');
    if(!f || !preview) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const result = e.target.result;
      if(f.type === 'image/svg+xml' || (typeof result === 'string' && result.trim().startsWith('<svg'))){
        preview.innerHTML = result;
        preview.dataset.pending = result;
        toast('SVG ready to save (click Save Logo).');
      } else {
        preview.innerHTML = `<img src="${result}" style="max-width:100%;max-height:100%;border-radius:6px">`;
        preview.dataset.pending = result;
        toast('Image ready to save (click Save Logo).');
      }
    };
    if(f.type === 'image/svg+xml') reader.readAsText(f);
    else reader.readAsDataURL(f);
  });
}

const saveLogoBtn = $('#saveLogoBtn');
if(saveLogoBtn){
  saveLogoBtn.addEventListener('click', ()=>{
    if(!isAdmin()){ toast('Only admin can save logo'); return; }
    const preview = $('#logoPreview');
    if(!preview || !preview.dataset.pending){ toast('No uploaded logo to save'); return; }
    try{
      localStorage.setItem(LOGO_KEY, preview.dataset.pending);
      loadSavedLogo();
      delete preview.dataset.pending;
      if(logoFileEl) logoFileEl.value = '';
      toast('Logo saved locally (browser).');
    } catch(err){ console.error(err); toast('Failed to save logo'); }
  });
}

const downloadLogoBtn = $('#downloadLogoBtn');
if(downloadLogoBtn){
  downloadLogoBtn.addEventListener('click', ()=>{
    const raw = localStorage.getItem(LOGO_KEY);
    if(!raw){ toast('No saved logo to download'); return; }
    if(raw.startsWith('<svg') || raw.includes('<svg')){
      const blob = new Blob([raw], {type:'image/svg+xml'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'smartcrime-logo.svg'; a.click(); URL.revokeObjectURL(a.href);
    } else if(raw.startsWith('data:')){
      fetch(raw).then(res=>res.blob()).then(blob=>{
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'smartcrime-logo.png'; a.click(); URL.revokeObjectURL(a.href);
      });
    } else {
      const blob = new Blob([raw], {type:'image/svg+xml'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'smartcrime-logo.svg'; a.click(); URL.revokeObjectURL(a.href);
    }
    toast('Download started');
  });
}

const resetLogoBtn = $('#resetLogoBtn');
if(resetLogoBtn){
  resetLogoBtn.addEventListener('click', ()=>{
    if(!isAdmin()){ toast('Only admin can reset logo'); return; }
    localStorage.removeItem(LOGO_KEY);
    loadSavedLogo();
    toast('Logo reset to default (local).');
  });
}

/* -------------------------
   Init / keyboard handling
   ------------------------- */
document.addEventListener('keydown', e=>{
  if(e.key === 'Enter' && $('#loginModal') && $('#loginModal').style.display !== 'none'){ doLogin(); }
});
document.addEventListener('DOMContentLoaded', ()=>{ loadSavedLogo(); });
</script>
</body>
</html>
